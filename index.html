<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鬱金香控股: 模擬投資競賽</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #DAA520;
            --secondary-color: #00E5FF;
            --background-color: #10121a;
            --surface-color: #1a1c25;
            --text-color: #e0e0e0;
            --text-muted-color: #888;
            --positive-color: #4CAF50;
            --negative-color: #F44336;
            --danger-color: #c0392b;
            --font-heading: 'Orbitron', 'Noto Sans TC', sans-serif;
            --font-body: 'Noto Sans TC', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); background-color: var(--background-color); color: var(--text-color); line-height: 1.7; font-size: 16px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--primary-color); margin-bottom: 1rem; text-shadow: 0 0 5px rgba(218, 165, 32, 0.5); }
        button, input[type="submit"], .file-input-label { font-family: var(--font-heading); cursor: pointer; transition: all 0.3s ease; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        .page { display: none; animation: fadeIn 0.8s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #page1 { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: linear-gradient(rgba(16, 18, 26, 0.85), rgba(16, 18, 26, 1)), url('01.png') no-repeat center center/cover; }
        #page1 h1 { font-size: 3.5rem; }
        #page1 .timeline { margin: 1.5rem 0; padding: 1rem; border: 1px solid var(--secondary-color); border-radius: 8px; background-color: rgba(0, 229, 255, 0.05); }
        #page1 .timeline p { margin: 0.5rem 0; font-size: 1.1rem; }
        .form-group { margin: 1.5rem 0; width: 100%; max-width: 400px; }
        .form-group label { display: block; margin-bottom: 0.5rem; text-align: left; font-weight: 500; }
        .form-group input { width: 100%; padding: 0.8rem; background-color: var(--surface-color); border: 1px solid #444; border-radius: 5px; color: var(--text-color); font-size: 1rem; }
        .form-group .helper-text { font-size: 0.8rem; color: var(--text-muted-color); text-align: left; margin-top: 0.3rem; }
        .form-group .error-text { color: var(--danger-color); font-size: 0.9rem; text-align: left; margin-top: 0.5rem; display: none; min-height: 1.2em; }
        .form-group input.invalid { border-color: var(--danger-color); }
        .next-button { padding: 0.8rem 2.5rem; background-color: var(--primary-color); color: var(--background-color); border: none; border-radius: 5px; font-size: 1.2rem; font-weight: 700; }
        .next-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4); }
        #page2 .page-header { text-align: center; margin-bottom: 2rem; }
        .portfolio-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; align-items: stretch; }
        @media (max-width: 992px) { .portfolio-layout { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .portfolio-layout { grid-template-columns: 1fr; } }
        .sinner-investment-card, .portfolio-summary { background-color: var(--surface-color); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; }
        .sinner-investment-card { position: relative; border-left: 4px solid var(--secondary-color); }
        .portfolio-summary { border-left: 4px solid var(--primary-color); justify-content: center; align-items: center; text-align: center; }
        .sinner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; min-height: 42px; }
        .sinner-header h3 { margin: 0; font-size: 1.1rem; line-height: 1.2; }
        .organization-name { font-size: 0.8em; color: var(--text-muted-color); font-weight: 400; }
        .investment-controls { margin-top: auto; padding-top: 1.5rem; }
        .investment-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-family: var(--font-heading); }
        .investment-display label { font-size: 0.9rem; }
        .investment-display span { font-size: 1.2rem; color: var(--primary-color); font-weight: 700; }
        .slider-container { display: flex; align-items: center; gap: 0.5rem; }
        .adjust-btn { background-color: #444; color: var(--text-color); border: none; width: 30px; height: 30px; font-size: 1.5rem; line-height: 30px; border-radius: 50%; flex-shrink: 0; }
        .adjust-btn:hover { background-color: var(--primary-color); color: var(--background-color); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; background: #333; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 2px solid var(--background-color); }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 2px solid var(--background-color); }
        .chart-and-info-container { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; align-items: center; }
        .event-chart-container { flex-shrink: 0; position: relative; width: 150px; height: 150px; cursor: pointer; }
        .chart-avatar { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border-radius: 50%; border: none; pointer-events: none; background-color: var(--surface-color); }
        .chart-cta { position: absolute; bottom: 0px; right: 0px; transform: translateX(calc(100% + 5px)); width: max-content; font-size: 0.7rem; color: var(--text-muted-color); font-style: italic; pointer-events: none; }
        @media (max-width: 1200px) { .chart-cta { transform: none; width: 100%; text-align: center; bottom: -20px; right: auto; left: 50%; transform: translateX(-50%); } }
        .event-description-box { width: 100%; min-height: 80px; font-size: 0.9rem; color: var(--text-muted-color); display: flex; align-items: center; }
        .event-description-box p { text-align: left; width: 100%; }
        .portfolio-summary p { font-size: 1.2rem; margin: 0.5rem 0; }
        #remainingFunds.negative { color: var(--negative-color); }
        .submit-portfolio { padding: 0.8rem 2.5rem; background-color: var(--primary-color); color: var(--background-color); border: none; border-radius: 5px; font-size: 1.2rem; font-weight: 700; margin-top: 1rem; }
        #page3 h2, #page3 h3 { text-align: center; }
        #page3 h3 { color: var(--secondary-color); margin-bottom: 1.5rem; }
        .todays-events-section { margin-bottom: 3rem; }
        .todays-events-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem; }
        @media (max-width: 1199px) { .todays-events-grid { display: flex; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 1rem; } }
        .today-event-card { background-color: var(--surface-color); border-radius: 8px; padding: 1.5rem; text-align: center; border-bottom: 4px solid; flex: 1 0 220px; }
        .today-event-card.positive { border-color: var(--positive-color); }
        .today-event-card.negative { border-color: var(--negative-color); }
        .today-event-card .sinner-name { font-weight: 700; color: var(--text-color); font-size: 1.1rem; margin-bottom: 1rem; }
        .today-event-card .event-impact { font-family: var(--font-heading); font-size: 3rem; font-weight: 700; margin-bottom: 1rem; }
        .today-event-card .event-impact.positive { color: var(--positive-color); }
        .today-event-card .event-impact.negative { color: var(--negative-color); }
        .today-event-card .event-desc { font-size: 0.9rem; color: var(--text-muted-color); min-height: 50px; }
        .market-view-container { background-color: var(--surface-color); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; }
        .market-view-grid { display: grid; grid-template-columns: 120px repeat(5, 1fr); gap: 1px; background-color: #444; border: 1px solid #444; min-width: 900px; }
        .market-view-container-desktop { overflow-x: auto; }
        .market-view-cell { background-color: var(--background-color); padding: 0.5rem; font-size: 0.8rem; }
        .market-view-header { background-color: #2a2a2a; font-family: var(--font-heading); font-weight: 700; text-align: center; color: var(--primary-color); position: sticky; top: 0; z-index: 3; white-space: nowrap; }
        .date-header { text-align: left; position: sticky; left: 0; z-index: 2; }
        .event-cell { min-height: 60px; }
        .event-cell .event-desc { color: var(--text-color); font-size: 0.85rem; }
        .event-cell .event-impact { font-weight: 700; text-align: right; display: block; margin-top: 0.5rem; }
        .event-cell .event-impact.positive { color: var(--positive-color); }
        .event-cell .event-impact.negative { color: var(--negative-color); }
        .market-view-mobile-card { background-color: var(--background-color); border: 1px solid #444; border-radius: 5px; margin-bottom: 1rem; padding: 1rem; }
        .market-view-mobile-card h4 { color: var(--primary-color); margin: 0 0 1rem 0; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        .mobile-event-item { display: grid; grid-template-columns: 1fr auto; gap: 0.5rem 1rem; padding: 0.5rem 0; border-bottom: 1px solid #2a2a2a; }
        .mobile-event-item:last-child { border-bottom: none; }
        .mobile-event-item .sinner-name { grid-column: 1 / 2; font-weight: bold; }
        .mobile-event-item .event-impact { grid-column: 2 / 3; grid-row: 1 / 3; align-self: center; font-size: 1.2rem; font-weight: 700; }
        .mobile-event-item .event-impact.positive { color: var(--positive-color); }
        .mobile-event-item .event-impact.negative { color: var(--negative-color); }
        .mobile-event-item .event-desc { grid-column: 1 / 2; font-size: 0.85rem; color: var(--text-muted-color); }
        #marketViewMobile { display: none; }
        @media (max-width: 768px) { .market-view-container-desktop { display: none; } #marketViewMobile { display: block; } }
        .leaderboard-table-container { overflow-x: auto; }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
        .leaderboard-table th, .leaderboard-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid #333; vertical-align: middle; }
        .leaderboard-table thead { background-color: #2a2a2a; }
        .leaderboard-table thead th { color: var(--primary-color); }
        .leaderboard-table tbody tr:nth-child(-n+10) { background-color: rgba(76, 175, 80, 0.05); }
        .leaderboard-table tbody tr:nth-last-child(-n+10) { background-color: rgba(244, 67, 54, 0.05); }
        .leaderboard-table .rank { font-family: var(--font-heading); font-weight: 700; }
        .leaderboard-table .nickname { font-weight: 500; }
        .leaderboard-table .portfolio-details { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .portfolio-item { font-size: 0.8rem; color: var(--text-muted-color); white-space: nowrap; }
        .portfolio-item strong { color: var(--text-color); font-weight: 700; }
        .leaderboard-table .net-worth { font-weight: 700; font-family: var(--font-heading); }
        .daily-change { font-weight: 700; font-family: var(--font-heading); }
        .daily-change.positive { color: var(--positive-color); }
        .daily-change.negative { color: var(--negative-color); }
        @keyframes highlight-row-animation { from { background-color: rgba(218, 165, 32, 0.5); } to { background-color: transparent; } }
        .highlight-row { animation: highlight-row-animation 3s ease-out; }
        #pageAdmin { background-color: #2c3e50; padding: 2rem; border-radius: 8px; }
        #pageAdmin h1, #pageAdmin h2 { color: #f1c40f; }
        .admin-section { background-color: #34495e; padding: 1.5rem; margin-bottom: 2rem; border-radius: 8px; }
        #pageAdmin label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        #pageAdmin select, #pageAdmin input { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 4px; border: none; }
        #updateMarketBtn, .delete-player-btn, .admin-button { background-color: #e67e22; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; margin-right: 1rem; }
        #updateMarketBtn:hover, .delete-player-btn:hover, .admin-button:hover { background-color: #d35400; }
        .delete-player-btn, #resetDataBtn { background-color: var(--danger-color); }
        .delete-player-btn:hover, #resetDataBtn:hover { background-color: #e74c3c; }
        .file-input-label { display: inline-block; padding: 0.8rem 1.5rem; background-color: #3498db; color: white; border-radius: 4px; }
        .file-input-label:hover { background-color: #2980b9; }
        #importDataInput { display: none; }
        #status { margin-top: 1rem; padding: 1rem; background-color: #27ae60; color: white; border-radius: 4px; display: none; text-align: center;}
        #playerManagerTable, #eventHistoryTable { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #playerManagerTable th, #playerManagerTable td, #eventHistoryTable th, #eventHistoryTable td { padding: 0.5rem; border: 1px solid #46627f; text-align: left; }
        #playerManagerTable th, #eventHistoryTable th { background-color: #2c3e50; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 8px; border: 1px solid var(--primary-color); width: 90%; max-width: 500px; text-align: center; }
        #portfolioReview { text-align: left; margin: 1.5rem 0; max-height: 250px; overflow-y: auto; border: 1px solid #444; padding: 1rem; border-radius: 5px; }
        #portfolioReview p { display: flex; justify-content: space-between; }
        #portfolioReview .sinner-name { color: var(--text-muted-color); }
        #portfolioReview .amount { font-family: var(--font-heading); color: var(--primary-color); }
        .modal-warning { color: var(--negative-color); font-weight: bold; margin-bottom: 1.5rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        .modal-buttons button { padding: 0.6rem 1.5rem; border-radius: 5px; font-size: 1rem; }
        #confirmSubmitBtn { background-color: var(--primary-color); color: var(--background-color); border: none; }
        #cancelSubmitBtn { background-color: transparent; color: var(--text-muted-color); border: 1px solid var(--text-muted-color); }
        #rulesModal .modal-content, #eventListModal .modal-content { text-align: left; max-width: 700px; }
        #rulesModal ul, #eventListModal ul { padding-left: 1.5rem; margin: 1rem 0; }
        #rulesModal li, #eventListModal li { margin-bottom: 0.5rem; }
        #rulesModal .rule-highlight { color: var(--negative-color); font-weight: bold; }
        #closeRulesBtn, #closeEventListBtn { display: block; margin: 1.5rem auto 0; }
        .rules-link { text-decoration: underline; color: var(--secondary-color); cursor: pointer; font-size: 0.9rem; }
        .agree-section { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        #eventListModalContent { max-height: 70vh; overflow-y: auto; }
        #eventListModalContent p { padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 0.9rem; }
        #eventListModalContent p.positive { background-color: rgba(76, 175, 80, 0.1); }
        #eventListModalContent p.negative { background-color: rgba(244, 67, 54, 0.1); }
        #eventListModalContent .event-value { font-weight: 700; }
        #eventListModalContent .event-value.positive { color: var(--positive-color); }
        #eventListModalContent .event-value.negative { color: var(--negative-color); }
        #eventReviewButtons { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
        #eventReviewButtons button { background-color: var(--surface-color); border: 1px solid var(--secondary-color); color: var(--secondary-color); padding: 0.5rem 1rem; }
        #eventReviewButtons button:hover { background-color: var(--secondary-color); color: var(--background-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="page1" class="page">
            <div class="hero-content">
                <h1>鬱金香控股</h1>
                <p>模擬投資競賽</p>
                <div class="timeline">
                    <p><strong>【投資報名週】</strong>7/15 - 7/20</p>
                    <p><strong>【股市開市】</strong>7/21 - 8/3</p>
                </div>
                <div id="registrationForm">
                    <div class="form-group">
                        <label for="uid">遊戲UID</label>
                        <input type="text" id="uid" placeholder="請輸入您的15位數字UID">
                        <p class="helper-text">必填，點選遊戲內等級圖示即可進入局長資訊介面複製ID</p>
                        <p id="uidError" class="error-text">UID必須為15位數字</p>
                    </div>
                    <div class="form-group">
                        <label for="nickname">競賽暱稱</label>
                        <input type="text" id="nickname" placeholder="例如：狄斯城郭台銘">
                        <p class="helper-text">敏感字詞將直接取消資格，且可能影響帳號參與後續社群活動資格</p>
                        <p id="nicknameError" class="error-text">暱稱包含不當詞彙，請修改。</p>
                    </div>
                    <div class="agree-section">
                        <input type="checkbox" id="agreeCheckbox">
                        <label for="agreeCheckbox" style="margin: 0;">我已閱讀並同意<span id="rulesLink" class="rules-link">活動規則</span></label>
                    </div>
                </div>
                <button id="toPage2Btn" class="next-button" disabled>下一步 / 查詢結果</button>
                <div id="registrationClosed" style="display:none; color: var(--danger-color); margin-top: 1.5rem;">
                    <h3>報名已截止</h3>
                    <p>感謝您的參與，第一天市場已開盤，無法再進行報名。</p>
                </div>
            </div>
        </div>
        <div id="page2" class="page">
            <div class="page-header">
                <h2>建立您的投資組合</h2>
                <p style="color: var(--text-muted-color);">將您的100萬狄斯幣分配給您看好的禁閉者。最小投資單位為1千。</p>
            </div>
            <div id="portfolioLayout" class="portfolio-layout">
            </div>
        </div>
        <div id="page3" class="page">
            <h2>命運交易所 - 即時行情</h2>
            <div class="todays-events-section">
                <h3 id="todaysEventsTitle">當日事件 (尚未開市)</h3>
                <div id="todaysEventsGrid" class="todays-events-grid">
                </div>
            </div>
            <div class="market-view-container">
                <h3>歷史事件回顧</h3>
                <div id="marketViewContainerDesktop" class="market-view-container-desktop">
                    <div id="marketViewGrid" class="market-view-grid">
                    </div>
                </div>
                <div id="marketViewMobile" class="market-view-container-mobile">
                </div>
            </div>
            <div class="leaderboard-table-container">
                <h3>玩家資產排行榜</h3>
                <div id="eventReviewButtons">
                </div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th class="rank">排名</th>
                            <th class="nickname">競賽暱稱</th>
                            <th class="uid">UID</th>
                            <th class="portfolio">投資組合 (股)</th>
                            <th class="net-worth">目前總身價</th>
                            <th class="daily-change">單日漲跌</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="pageAdmin" class="page">
             <h1>命運交易所 - 後台管理</h1>
            <div class="admin-section" id="marketUpdater">
                <h2>市場事件更新</h2>
                <p>請為每一位禁閉者選擇今天觸發的「命運事件」，然後點擊下方的「更新市場」按鈕。</p>
                <div id="adminControls">
                </div>
                <button id="updateMarketBtn">更新市場</button>
                <div id="status"></div>
                <div id="eventHistory">
                    <h3>歷史更新記錄</h3>
                    <table id="eventHistoryTable">
                         <thead><tr><th>日期</th><th>操作</th></tr></thead>
                         <tbody id="eventHistoryBody">
                         </tbody>
                    </table>
                </div>
            </div>
            <div class="admin-section" id="playerManager">
                <h2>玩家管理</h2>
                <table id="playerManagerTable">
                    <thead>
                        <tr>
                            <th>UID</th>
                            <th>競賽暱稱</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="playerManagerBody">
                    </tbody>
                </table>
            </div>
            <div class="admin-section" id="dataManager">
                <h2>資料管理</h2>
                <p>您可以匯出目前的完整資料作為備份，或匯入備份檔來還原狀態。</p>
                <button id="exportDataBtn" class="admin-button">匯出玩家與市場資料</button>
                <label for="importDataInput" class="file-input-label">匯入資料還原狀態</label>
                <input type="file" id="importDataInput" accept=".json" style="display: none;">
                <hr style="margin: 2rem 0; border-color: #444;">
                <p>警告：此操作將會清空所有玩家報名資料及市場事件，並將股價重置為初始狀態。</p>
                <button id="resetDataBtn" class="admin-button">重置所有資料</button>
            </div>
        </div>
    </div>
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3>確認您的投資組合</h3>
            <div id="portfolioReview">
            </div>
            <p class="modal-warning">提交後無法修改</p>
            <div class="modal-buttons">
                <button id="cancelSubmitBtn">返回修改</button>
                <button id="confirmSubmitBtn">確認提交</button>
            </div>
        </div>
    </div>
    <div id="rulesModal" class="modal-overlay">
        <div class="modal-content">
            <h3>活動規則與條款</h3>
            <ul>
                <li>每位局長僅限使用一個UID報名一次，重複報名將不予計算。</li>
                <li>競賽暱稱不得包含不當或敏感詞彙，違者將取消資格。</li>
                <li>投資組合一經提交後，便無法進行任何修改。</li>
                <li>為確保活動公平性，<span class="rule-highlight">最終獲獎者在領取獎勵時，需配合官方進行身份驗證，例如提供包含UID的遊戲內個人資料頁面截圖等。</span></li>
                <li><span class="rule-highlight">若無法證明為該UID的合法持有者，或發現使用他人UID參與，官方有權取消其獲獎資格。</span></li>
                <li>《無期迷途》官方保留對本活動規則的最終修改、變更、解釋及取消之權利。</li>
            </ul>
            <button id="closeRulesBtn" class="next-button">我已了解</button>
        </div>
    </div>
    <div id="eventListModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="eventListModalTitle"></h3>
            <div id="eventListModalContent">
            </div>
            <button id="closeEventListBtn" class="next-button">關閉</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6Mk9_VEOt3lnuHaBHqz_EIp4tQtI9Jx0",
            authDomain: "pathtonowhere-stock-game.firebaseapp.com",
            databaseURL: "https://pathtonowhere-stock-game-default-rtdb.firebaseio.com",
            projectId: "pathtonowhere-stock-game",
            storageBucket: "pathtonowhere-stock-game.appspot.com",
            messagingSenderId: "41180687616",
            appId: "1:41180687616:web:762421d6e98143b45ed7e5",
            measurementId: "G-QRDCSQ0SXM"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database, 'sinnerStockGame');

        document.addEventListener('DOMContentLoaded', function() {
            
            const SinnerData = {
                baiyi: { name: "白記實業 - 白逸 (Bai Yi)", avatar: '白逸.png', description: "白記實業的日常充滿了醜聞、黑料與營運危機。但憑藉「高超的手段」，一旦站上風口浪尖，就能瞬間扭轉乾坤，帶來一飛衝天的報酬。", events: [ { desc: "[正面] 白記實業武力技術獲第九機關、MBCC等單位大力讚揚，獲聘官方顧問。", value: 2.00 },{ desc: "[正面] 白逸歌聲備受肯定，獲選為城市代言曲主唱，歌曲火爆大街小巷，傳唱千里。", value: 1.60 },{ desc: "[正面] 成功為MBCC主辦一場極其盛大的晚宴，並於會中提供公司小廣告，酒酣耳熱間接獲不少新客戶委託。", value: 1.10 },{ desc: "[正面] 白逸參加辛迪加運動跑步賽事，榮獲冠軍，並打破大會紀錄，投資人認可老闆對目標的決心與耐力。", value: 0.60 },{ desc: "[負面] 公司財務報表被查出存在嚴重造假行為。", value: -0.60 },{ desc: "[負面] 白記全新研發智慧型裝置發表會上，樣品當眾爆炸。", value: -0.40 },{ desc: "[負面] 合作公司被查出多數是空殼公司，並涉嫌假交易與人頭帳戶疑雲。", value: -0.35 },{ desc: "[負面] 員工發生嚴重工安意外，被勒令停業整頓。", value: -0.25 },{ desc: "[負面] 企圖竊取競爭對手技術的「黑工」被當場抓獲。", value: -0.20 },{ desc: "[負面] 核心技術人員集體跳槽至敵對公司。", value: -0.18 },{ desc: "[負面] 因員工駕車打瞌睡，造成連環車禍並衝進知名劇院大門。", value: -0.15 },{ desc: "[負面] 供應商集體上門討要拖欠的款項。", value: -0.15 },{ desc: "[負面] 公司因惡性加班和勞資糾紛，遭到員工集體罷工。", value: -0.11 },{ desc: "[負面] 公司股票被權威機構評定為「不建議持有」。", value: -0.10 },{ desc: "[負面] 公司被爆出使用不合格的廉價物料，引發信任危機。", value: -0.09 },{ desc: "[負面] 公司日常營運出現資金周轉困難。", value: -0.09 },{ desc: "[負面] 白逸本人被狗仔拍到出入辛迪加的秘密賭場。", value: -0.08 },{ desc: "[負面] 一個重要標案因「偷懶」未做足準備而競標失敗。", value: -0.08 },{ desc: "[負面] 於西區進行非法交易時受治安局臨檢，當場脫逃，以致交易破局。", value: -0.07 },{ desc: "[負面] 白逸又翹掉了重要的董事會。", value: -0.05 } ] },
                angel: { name: "暗網殺手組織 - 安吉爾 (Angel)", avatar: '安吉爾.png', description: "安吉爾的行動，總是冷酷且殘酷。每一次事件成功與否，都伴隨著大幅的風險與報酬，投資其組織每日都可能面臨劇烈擺盪。", events: [ { desc: "[正面] 成功「清除」競爭對手的所有員工，獨佔了整個西區的地下情報網。", value: 1.10 },{ desc: "[正面] 透過暗網接到來自有頭有臉大人物的單，並成功拉攏其勢力。", value: 0.70 },{ desc: "[正面] 透過暴力手段，獲取了一張藏有巨額財富的加密密鑰。", value: 0.58 },{ desc: "[正面] 安吉爾成功滲透進MBCC的後勤供應鏈，搬運大量物資變賣。", value: 0.45 },{ desc: "[正面] 在暗網上成功主導了一次針對敵對勢力的輿論戰，擊潰敵對陣營聲勢。", value: 0.30 },{ desc: "[正面] 客戶慕名而來，新增委託數名權貴大人物的預購訂單。", value: 0.28 },{ desc: "[正面] 與頂級駭客合作，獨家搶先拿下數筆委託。", value: 0.18 },{ desc: "[正面] 成功從一場黑市拍賣中，獲取了稀有的武器。", value: 0.15 },{ desc: "[正面] 近日安吉爾居所多了一名室友負責打掃與煮飯，為安吉爾提供良好生活品質。", value: 0.10 },{ desc: "[正面] 安吉爾執行任務時遇到可愛的貓，心情愉悅得迅速完成任務。", value: 0.08 },{ desc: "[負面] 一次「清除」行動出現意外，目標逃脫並向治安局提供了安吉爾的核心情報。", value: -0.65 },{ desc: "[負面] 安吉爾被知名週刊狗仔拍到並對外發布「神秘殺手」現身的專欄報導。", value: -0.55 },{ desc: "[負面] 安吉爾本人住所被仇家夷為平地。", value: -0.45 },{ desc: "[負面] 暗網上的匿名帳戶與真實身份的連結被曝光。", value: -0.35 },{ desc: "[負面] 任務執行時遇競爭對手受擊，傷勢嚴重。", value: -0.30 },{ desc: "[負面] 一次暴力行動的影像被洩漏至公網，引發民眾恐慌。", value: -0.20 },{ desc: "[負面] 一批重要貨物在運輸途中被黑吃黑。", value: -0.15 },{ desc: "[負面] 安吉爾本人因食用過期食品食物中毒，一個禮拜無法接單。", value: -0.10 },{ desc: "[負面] 安吉爾因睡過頭而「遲到」錯失客戶信任。", value: -0.08 },{ desc: "[負面] 安吉爾本人沒吃到紅豆湯情緒不穩。", value: -0.06 } ] },
                pearl: { name: "福爾圖娜劇院 - 珀爾夫人 (Lady Pearl)", avatar: '珀爾夫人.png', description: "劇院的日常充滿了藝術與掌聲，資產如同一場永不落幕的盛大演出般持續增值。但舞台之下，潛藏著足以讓一切瞬間崩塌的致命危機。", events: [ { desc: "[正面] 新劇《狄斯之淚》首演大獲成功，被譽為「十年來最偉大的戲劇」。", value: 0.25 },{ desc: "[正面] 成功獲得了新城文化基金的最高額度贊助。", value: 0.23 },{ desc: "[正面] 劇院與知名東洲說書人玉骨、辛迪加知名詩人渡鴉簽訂了獨家合作協議。", value: 0.18 },{ desc: "[正面] 音樂劇團宣布合作恩菲爾工作室同步展出高級藝術展覽。", value: 0.15 },{ desc: "[正面] 邀請狄斯卡金獎導演黛倫拍攝紀錄片，提升劇院知名度。", value: 0.13 },{ desc: "[正面] 成功舉辦了一場面向流民寨兒童的公益演出。", value: 0.13 },{ desc: "[正面] 一位傳奇舞者哈梅爾宣布在福爾圖娜劇院演出。", value: 0.12 },{ desc: "[正面] 劇院推出了新的會員制度，反應熱烈。", value: 0.12 },{ desc: "[正面] 劇院的建築本身被評定為「特級歷史保護文物」。", value: 0.11 },{ desc: "[正面] 新聞記者畢安卡給予本季新劇高度評價。", value: 0.11 },{ desc: "[正面] 劇院的年度財報顯示，票房與周邊收入均創歷史新高。", value: 0.10 },{ desc: "[正面] 劇院的燈光音響系統進行了全面升級。", value: 0.10 },{ desc: "[正面] 劇院的日常上座率穩定在9成以上。", value: 0.09 },{ desc: "[正面] 與知名藝術家恩菲爾、麥昆合作推出劇院的周邊新品，大獲好評。", value: 0.09 },{ desc: "[正面] 珀爾夫人推出的線上課程「如何一手打造優秀劇院」廣受好評。", value: 0.08 },{ desc: "[正面] 招募戲劇新星露薇婭‧蕾入麾下，演員們的日常排練順利。", value: 0.08 },{ desc: "[正面] 珀爾夫人登上了藝術雜誌封面。", value: 0.07 },{ desc: "[負面] 邀請東洲禁閉者「曜」進行東洲劇目演出，不慎引發毀滅性大火，整座劇院包含所有珍貴的佈景、戲服和歷史檔案付之一炬。", value: -0.95 },{ desc: "[負面] 劇院被卡車衝撞，嚴重影響營運，據傳駕駛暴衝是白X實業員工打瞌睡造成。", value: -0.78 },{ desc: "[負面] 劇院雇用白記實業例行維護，但維護不慎出現失誤，導致劇場人員受傷。", value: -0.15 } ] },
                irina: { name: "奎恩集團 - 伊琳娜 (Irina)", avatar: '伊琳娜.png', description: "奎恩企業表面上是治理完善的企業，總能有穩定的利多消息。但私下的違規經營與惡意併購，醜聞仍可能東窗事發，看似穩健卻暗藏危機。", events: [ { desc: "[正面] 集團憑藉其優秀的企業文化與經營方針，股東會交出超出預期的季度財報。", value: 0.24 },{ desc: "[正面] 集團旗下高端產品線推出新品，再次引領新城潮流。", value: 0.19 },{ desc: "[正面] 集團年度報告，被新城經濟學會作為「企業家精神」的正面案例進行研究。", value: 0.16 },{ desc: "[正面] 成功申請到數項關於「異方晶附加產業」的合法專利，為未來布局。", value: 0.14 },{ desc: "[正面] 旗下幻影娛樂多名藝人演出熱門新劇，據悉一集片酬高達一億狄斯幣。", value: 0.13 },{ desc: "[正面] 伊琳娜在《狄斯日報》上發表了一篇「商業與棋局」的深度文章，其商業才智備受推崇", value: 0.12 },{ desc: "[正面] 奎恩集團資助西區重建計畫，間接掌控了當地人脈與支持，進而增加集團異方晶貿易機會。", value: 0.11 },{ desc: "[正面] 旗下服飾品牌設計師為伊琳娜量裁禮服的影像曝光，品牌價值與形象提升。", value: 0.11 },{ desc: "[正面] 伊琳娜「商人應追尋最大利潤」的言論被財經雜誌評為年度語錄。", value: 0.10 },{ desc: "[正面] 伊琳娜霸氣、大方的螢幕形象，備受民眾與企業追捧。", value: 0.09 },{ desc: "[正面] 伊琳娜出席慈善晚宴，其優雅形象再次登上《狄斯日報》頭版。", value: 0.09 },{ desc: "[正面] 集團宣布為員工提供心理健康支持與西洋棋課程，被譽為「新城最佳雇主」。", value: 0.08 },{ desc: "[正面] 收到知名毛筆畫家致贈匾額「大展鴻圖」。", value: 0.08 },{ desc: "[正面] 伊琳娜送給局長的透明西洋棋子，被證實為價值不菲的藝術品。", value: 0.07 },{ desc: "[正面] 伊琳娜個人傳記出版並邀請詩人渡鴉協助撰寫，無論在新城還是西區都大受歡迎。", value: 0.06 },{ desc: "[正面] 伊琳娜投入青少年棋手培育計畫，充分展現企業社會責任。", value: 0.05 },{ desc: "[負面] 集團總裁伊琳娜遭踢爆為禁閉者，大量股東拋售股票。", value: -0.39 },{ desc: "[負面] 集團獲報與外邦勢力有染，遭政府當局取締並大規模搜索公司。", value: -0.26 },{ desc: "[負面] 受到新任外邦總理高額關稅政策影響，市場下調營收預估。", value: -0.20 },{ desc: "[負面] 受喚夏公館事件影響，奎恩集團遭受輿論衝擊與民眾抵制。", value: -0.15 } ] },
                daren: { name: "電影工作室 - 黛倫 (Daren)", avatar: '黛倫.png', description: "在電影事業中，一部驚世駭俗的神作或一次創作上的重大突破，能帶來豐厚回報；但創作瓶頸或是其情緒的波動，也會影響市場的信心。", events: [ { desc: "[正面] 世紀回歸！黛倫宣布重返影壇，新片企劃《狄斯卡沒有的答案》引發全城資本瘋狂追逐！", value: 0.41 },{ desc: "[正面] 煙煙開機帶領劇組拜拜，求神問財並預言成功！新電影票房大賣，掀起熱潮。", value: 0.30 },{ desc: "[正面] 與盜版平台的訴訟勝訴，成功打擊盜版勢力，拿回一大筆版權金。", value: 0.25 },{ desc: "[正面] 成功邀請幻影娛樂的當紅藝人娜恰出演新片，市場期待合作激發火花。", value: 0.21 },{ desc: "[正面] 黛倫邀請開爾文、伊格尼、伊芙、愛緹製作片場道具，場景逼真，拍攝成本大幅降低。", value: 0.16 },{ desc: "[正面] 局長成功安撫了因思鄉而情緒低落的嗷嗚，黛倫在一旁觀察，似乎對某種「共通情感」有了更深的理解。", value: 0.15 },{ desc: "[正面] 一位曾被她指導過的新人導演，在狄斯卡大獎上公開感謝黛倫的啟蒙。", value: 0.14 },{ desc: "[正面] 黛倫受邀登上金嘎獎最高殿堂演講，提攜後進，引發電影界熱潮。", value: 0.12 },{ desc: "[正面] 她的作品重新上映，引發了新一輪的學術研究熱潮，被譽為「怪誕浪漫喜劇的巔峰」。", value: 0.10 },{ desc: "[正面] 她舊片中一句諷刺資本的台詞被直播主妮諾剪成迷因，洗版社交平台，獲得年輕世代熱愛。", value: 0.08 },{ desc: "[負面] 局內意外失火，黛倫的靈感筆記全被燒成灰燼，她沉默不語地發呆了兩週。", value: -0.30 },{ desc: "[負面] 投資方曝光了合約，證明黛倫曾「自願」同意修改電影，引發粉絲對其藝術完整性的爭議。", value: -0.16 },{ desc: "[負面] 因攝影機損壞，送到白記實業進行快速維修，結果機器維修過程爆炸。", value: -0.14 },{ desc: "[負面] 黛倫尚未完成的電影構思外流，粉絲評價兩極造成損失。", value: -0.11 },{ desc: "[負面] 異能波動！黛倫因觀看一部爛片而情緒失控，將審查室內鈦合金椅「聯想」成了異變體。", value: -0.10 },{ desc: "[負面] 一名合作演員在拍攝時精神崩潰，將黛倫的劇本形容為「詛咒文字」，引發輿論風暴。", value: -0.09 },{ desc: "[負面] 嗷嗚不慎遺失了對她意義重大的獅頭，黛倫試圖幫忙尋找未果，友誼的小船出現危機，雙方情緒低落。", value: -0.08 },{ desc: "[負面] 拒絕了頒獎前所有來自狄斯卡大獎官方的採訪邀請，被評為「傲慢」。", value: -0.08 },{ desc: "[負面] 在狄斯卡大獎中落選後，記者採訪感言時她講的冷笑話讓氣氛降到冰點。", value: -0.06 },{ desc: "[負面] 日常行程：在自己的收容房間內躺了一整天，聲稱「正在為下一部作品體驗生活」。", value: -0.05 } ] }
            };
            const INITIAL_FUNDS = 1000000;
            const INITIAL_STOCK_PRICE = 1000;
            const MIN_INVESTMENT = 1000;
            const sensitiveWords = ["管理員", "GM", "官方", "客服", "admin", "幹", "操", "習近平", "習大大", "兩岸", "政治", "白癡", "智障", "低能", "中國", "習"];
            let db = {};

            const pages=document.querySelectorAll(".page"),uidInput=document.getElementById("uid"),nicknameInput=document.getElementById("nickname"),toPage2Btn=document.getElementById("toPage2Btn"),uidError=document.getElementById("uidError"),nicknameError=document.getElementById("nicknameError"),portfolioLayout=document.getElementById("portfolioLayout"),marketViewGrid=document.getElementById("marketViewGrid"),marketViewMobile=document.getElementById("marketViewMobile"),leaderboardBody=document.getElementById("leaderboardBody"),adminControls=document.getElementById("adminControls"),updateMarketBtn=document.getElementById("updateMarketBtn"),statusEl=document.getElementById("status"),playerManagerBody=document.getElementById("playerManagerBody"),confirmationModal=document.getElementById("confirmationModal"),portfolioReview=document.getElementById("portfolioReview"),confirmSubmitBtn=document.getElementById("confirmSubmitBtn"),cancelSubmitBtn=document.getElementById("cancelSubmitBtn"),todaysEventsGrid=document.getElementById("todaysEventsGrid"),todaysEventsTitle=document.getElementById("todaysEventsTitle"),exportDataBtn=document.getElementById("exportDataBtn"),importDataInput=document.getElementById("importDataInput"),resetDataBtn=document.getElementById("resetDataBtn"),eventHistoryBody=document.getElementById("eventHistoryBody"),agreeCheckbox=document.getElementById("agreeCheckbox"),rulesLink=document.getElementById("rulesLink"),rulesModal=document.getElementById("rulesModal"),closeRulesBtn=document.getElementById("closeRulesBtn"),eventListModal=document.getElementById("eventListModal"),eventListModalTitle=document.getElementById("eventListModalTitle"),eventListModalContent=document.getElementById("eventListModalContent"),closeEventListBtn=document.getElementById("closeEventListBtn");

            function saveDb(){set(dbRef,db)}function resetDb(){db={players:[],stocks:{},dailyEvents:[],gameStarted:!1};for(const e in SinnerData)db.stocks[e]={price:INITIAL_STOCK_PRICE};saveDb()}function navigateTo(e){pages.forEach(e=>e.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active")}function validateInputs(){if(!uidInput||!nicknameInput||!agreeCheckbox)return;const e=uidInput.value.trim(),t=nicknameInput.value.trim(),a=/^\d{15}$/.test(e);uidError.style.display=a||0===e.length?"none":"block",uidInput.classList.toggle("invalid",!a&&e.length>0);const n=sensitiveWords.find(e=>t.toLowerCase().includes(e.toLowerCase()));n&&t.length>0?(nicknameError.style.display="block",nicknameInput.classList.add("invalid")):(nicknameError.style.display="none",nicknameInput.classList.remove("invalid")),toPage2Btn.disabled=!(a&&agreeCheckbox.checked&&!n)}function handlePage1Next(){if(db.gameStarted)return void alert("抱歉局長，報名階段已過");const e=uidInput.value.trim();(db.players||[]).some(t=>t.uid===e)?(alert("此UID已報名，將直接跳轉至排行榜。"),localStorage.setItem("sinnerStockGameUID",e),renderAllPage3(),navigateTo("page3"),setTimeout(()=>{const t=document.getElementById(`player-row-${e}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-row"),setTimeout(()=>t.classList.remove("highlight-row"),3e3))},100)):(buildPortfolioPage(),navigateTo("page2"),setTimeout(()=>{const e=document.querySelector("#page2 .page-header");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100))}function buildPortfolioPage(){if(!portfolioLayout)return;portfolioLayout.innerHTML="";for(const e in SinnerData){const t=SinnerData[e],a=document.createElement("div");a.className="sinner-investment-card";const n=t.name.split(" - ");a.innerHTML=`<div class="sinner-header"><h3>${n.length>1?`${n[0]} - <span class="organization-name">${n[1]}</span>`:t.name}</h3></div><div class="chart-and-info-container"><div class="event-description-box" id="desc-box-${e}"></div><div class="event-chart-container" data-sinner="${e}"><img src="${t.avatar}" class="chart-avatar" alt="${t.name} avatar"><canvas id="chart-${e}"></canvas><p class="chart-cta">*點擊查看命運事件</p></div></div><div class="investment-controls"><div class="investment-display"><label for="${e}_input">投資金額:</label><span id="${e}_display">0</span></div><div class="slider-container"><button class="adjust-btn minus-btn" data-sinner-id="${e}">-</button><input type="range" id="${e}_input" class="investment-input" data-sinner="${e}" min="0" max="${INITIAL_FUNDS}" step="${MIN_INVESTMENT}" value="0"><button class="adjust-btn plus-btn" data-sinner-id="${e}">+</button></div></div>`,portfolioLayout.appendChild(a)}const e=document.createElement("div");e.className="portfolio-summary",e.innerHTML='<p>總投資金額: <span id="totalInvestment">0</span> / 1,000,000</p><p>剩餘資金: <span id="remainingFunds">1,000,000</span></p><button id="submitPortfolioBtn" class="submit-portfolio" disabled>提交投資組合</button>',portfolioLayout.appendChild(e),document.getElementById("submitPortfolioBtn").addEventListener("click",showConfirmationModal),document.querySelectorAll(".investment-input").forEach(e=>{e.addEventListener("input",handleInvestmentInput)}),document.querySelectorAll(".adjust-btn").forEach(e=>{e.addEventListener("click",handleAdjustButton)}),document.querySelectorAll(".event-chart-container").forEach(e=>{e.addEventListener("click",t=>showEventListModal(t.currentTarget.dataset.sinner))}),setTimeout(renderAllCharts,0),updatePortfolioSummary()}function renderAllCharts(){for(const e in SinnerData)renderPieChart(e)}function valueToColor(e,t,a){if(0===e)return"rgba(136, 136, 136, 0.7)";let n,o,i;if(e>0){const l=Math.sqrt(e/a),s=[165,214,167],d=[27,94,32];n=s[0]+(d[0]-s[0])*l,o=s[1]+(d[1]-s[1])*l,i=s[2]+(d[2]-s[2])*l}else{const l=Math.sqrt(e/t),s=[239,154,154],d=[183,28,28];n=s[0]+(d[0]-s[0])*l,o=s[1]+(d[1]-s[1])*l,i=s[2]+(d[2]-s[2])*l}return`rgb(${Math.round(n)}, ${Math.round(o)}, ${Math.round(i)})`}function renderPieChart(e){const t=document.getElementById(`chart-${e}`),a=document.getElementById(`desc-box-${e}`);if(!t||!a)return;a.innerHTML=`<p>${SinnerData[e].description}</p>`;const n=t.getContext("2d"),o=SinnerData[e].events,i=Math.max(...o.map(e=>e.value).filter(e=>e>0),0),l=Math.min(...o.map(e=>e.value).filter(e=>e<0),0),s={labels:o.map(e=>e.desc),datasets:[{data:Array(o.length).fill(1),backgroundColor:o.map(e=>valueToColor(e.value,l,i)),borderColor:"#1a1c25",borderWidth:2,hoverBorderWidth:4,hoverBorderColor:"#DAA520"}]};new Chart(n,{type:"doughnut",data:s,options:{responsive:!0,maintainAspectRatio:!1,cutout:"40%",plugins:{legend:{display:!1},tooltip:{enabled:!1}}}})}function handleInvestmentInput(e){const t=e.target;let a=0;document.querySelectorAll(".investment-input").forEach(e=>{e!==t&&(a+=Number(e.value))});const n=INITIAL_FUNDS-a;Number(t.value)>n&&(t.value=n),updatePortfolioSummary()}function handleAdjustButton(e){const t=e.target.dataset.sinnerId,a=document.getElementById(`${t}_input`);if(!a)return;let n=Number(a.value),o=0;document.querySelectorAll(".investment-input").forEach(e=>{e!==a&&(o+=Number(e.value))});const i=INITIAL_FUNDS-o;e.target.classList.contains("plus-btn")?n<i&&(a.value=n+MIN_INVESTMENT):e.target.classList.contains("minus-btn")&&(a.value=Math.max(0,n-MIN_INVESTMENT)),updatePortfolioSummary()}function updatePortfolioSummary(){let e=0;document.querySelectorAll(".investment-input").forEach(t=>{const a=Number(t.value);e+=a;const n=document.getElementById(`${t.dataset.sinner}_display`);n&&(n.textContent=a.toLocaleString())});const t=document.getElementById("totalInvestment"),a=document.getElementById("remainingFunds"),n=document.getElementById("submitPortfolioBtn");t&&(t.textContent=e.toLocaleString());const o=INITIAL_FUNDS-e;a&&(a.textContent=o.toLocaleString()),o<0?a&&a.classList.add("negative"):a&&a.classList.remove("negative"),n&&(n.disabled=e!==INITIAL_FUNDS)}function showConfirmationModal(){let e="";document.querySelectorAll(".investment-input").forEach(t=>{const a=Number(t.value);if(a>0){const n=SinnerData[t.dataset.sinner].name;e+=`<p><span class="sinner-name">${n}:</span> <span class="amount">${a.toLocaleString()} 狄斯幣</span></p>`}}),portfolioReview.innerHTML=e,confirmationModal.style.display="flex"}function hideConfirmationModal(){confirmationModal.style.display="none"}function submitPortfolio(){const e=uidInput.value.trim(),t=nicknameInput.value.trim()||`局長${e.slice(-4)}`;if((db.players||[]).some(t=>t.uid===e))return void alert("此UID已報名，無法重複提交！");const a={};document.querySelectorAll(".investment-input").forEach(e=>{const t=Number(e.value);t>0&&(a[e.dataset.sinner]=t)}),db.players||(db.players=[]),db.players.push({uid:e,nickname:t,portfolio:a}),localStorage.setItem("sinnerStockGameUID",e),saveDb(),hideConfirmationModal(),alert("投資組合提交成功！祝您投資順利！")}function renderAllPage3(){renderTodaysEvents(),renderHistoricalMarketView(),renderLeaderboard(),buildEventReviewButtons()}function calculateNetWorth(e,t){let a=0;for(const n in e){const o=e[n],i=t[n]?t[n].price:INITIAL_STOCK_PRICE,l=o/INITIAL_STOCK_PRICE;a+=l*i}return a}function renderLeaderboard(){leaderboardBody.innerHTML="";const e=db.players||[];if(0===e.length)return void(leaderboardBody.innerHTML='<tr><td colspan="6" style="text-align:center; color: var(--text-muted-color);">目前尚無玩家參與。</td></tr>');let t=null;if(db.dailyEvents&&db.dailyEvents.length>=1){t={};for(const e in SinnerData)t[e]={price:INITIAL_STOCK_PRICE};db.dailyEvents.slice(0,db.dailyEvents.length-1).forEach(e=>{e.events.forEach(e=>{t[e.sinnerId].price*=1+e.change})})}const a=e.map(e=>{const a=calculateNetWorth(e.portfolio,db.stocks);let n="N/A",o="";if(t){const i=calculateNetWorth(e.portfolio,t);if(i>0){const t=((a/i)-1)*100;n=(t>=0?"+":"")+t.toFixed(2)+"%",o=t>0?"positive":t<0?"negative":""}}let i="";for(const t in e.portfolio){const a=e.portfolio[t]/INITIAL_STOCK_PRICE;a>0&&(i+=`<div class="portfolio-item">${SinnerData[t].name.split(" - ")[0]}: <strong>${a.toFixed(0)}股</strong></div>`)}return{...e,netWorth:a,portfolioDetailsHtml:i,dailyChangeText:n,dailyChangeClass:o}}).sort((e,t)=>t.netWorth-e.netWorth);a.forEach((e,t)=>{const a=document.createElement("tr");a.id=`player-row-${e.uid}`,a.innerHTML=`<td class="rank">${t+1}</td><td class="nickname">${e.nickname}</td><td class="uid">${e.uid}</td><td class="portfolio-details">${e.portfolioDetailsHtml}</td><td class="net-worth">${Math.round(e.netWorth).toLocaleString()}</td><td class="daily-change ${e.dailyChangeClass}">${e.dailyChangeText}</td>`,leaderboardBody.appendChild(a)})}function renderTodaysEvents(){todaysEventsGrid.innerHTML="";const e=db.dailyEvents||[],t=e.length>0?e[e.length-1]:null;if(todaysEventsTitle.textContent=t?`當日事件 (${t.date})`:"當日事件 (尚未開市)",!t)return void(todaysEventsGrid.innerHTML='<p style="color: var(--text-muted-color); text-align: center; grid-column: 1 / -1;">等待市場開市...</p>');for(const e in SinnerData){const a=t.events.find(t=>t.sinnerId===e),n=document.createElement("div");if(a){const e=100*a.change,t=e>0?"positive":"negative",o=(e>0?"+":"")+e.toFixed(0)+"%";n.className=`today-event-card ${t}`,n.innerHTML=`<p class="sinner-name">${SinnerData[a.sinnerId].name.split(" - ")[0]}</p><p class="event-impact ${t}">${o}</p><p class="event-desc">${a.eventDesc}</p>`}else n.className="today-event-card",n.innerHTML=`<p class="sinner-name">${SinnerData[e].name.split(" - ")[0]}</p><p class="event-impact">--</p><p class="event-desc">本日無事件</p>`;todaysEventsGrid.appendChild(n)}}function renderHistoricalMarketView(){const e=["7/21","7/22","7/23","7/24","7/25","7/28","7/29","7/30","7/31","8/1"],t=db.dailyEvents||[];marketViewGrid.innerHTML="";let a='<div class="market-view-cell market-view-header date-header">交易日</div>';for(const e in SinnerData){const t=SinnerData[e].name.split(" - ");a+=`<div class="market-view-cell market-view-header">${t.length>1?`${t[0]} - <span class="organization-name">${t[1]}</span>`:SinnerData[e].name}</div>`}marketViewGrid.innerHTML=a,e.forEach((e,a)=>{let n=`<div class="market-view-cell date-header">${e}</div>`;for(const e in SinnerData){let o="";if(t[a]){const i=t[a].events.find(t=>t.sinnerId===e);if(i){const e=100*i.change,t=e>0?"positive":"negative",a=(e>0?"+":"")+e.toFixed(0)+"%";o=`<p class="event-desc">${i.eventDesc}</p><span class="event-impact ${t}">${a}</span>`}}n+=`<div class="market-view-cell event-cell">${o}</div>`}marketViewGrid.innerHTML+=n}),marketViewMobile.innerHTML="",e.forEach((e,a)=>{if(t[a]){const n=document.createElement("div");n.className="market-view-mobile-card";let o=`<h4>${e}</h4>`;const i=t[a].events;for(const e in SinnerData){const t=i.find(t=>t.sinnerId===e);if(t){const a=100*t.change,n=a>0?"positive":"negative",i=(a>0?"+":"")+a.toFixed(0)+"%";o+=`<div class="mobile-event-item"><span class="sinner-name">${SinnerData[e].name.split(" - ")[0]}</span><p class="event-desc">${t.eventDesc}</p><span class="event-impact ${n}">${i}</span></div>`}}n.innerHTML=o,marketViewMobile.appendChild(n)}})}function buildAdminControls(){if(!adminControls)return;adminControls.innerHTML="";for(const e in SinnerData){const t=SinnerData[e],a=db.stocks&&db.stocks[e]?db.stocks[e].price.toFixed(2):"N/A";let n=t.events.map((e,t)=>{const a=(e.value>0?"+":"")+(100*e.value).toFixed(0)+"%";return`<option value="${t}">${a} | ${e.desc}</option>`}).join("");adminControls.innerHTML+=`<div class="sinner-control"><h2>${t.name}</h2><p>目前股價: ${a} 狄斯幣</p><label for="${e}_select">選擇今日事件:</label><select id="${e}_select">${n}</select></div>`}}function buildPlayerManager(){if(!playerManagerBody)return;playerManagerBody.innerHTML="";const e=db.players||[];if(0===e.length)return void(playerManagerBody.innerHTML='<tr><td colspan="3" style="text-align:center;">尚無玩家</td></tr>');e.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`<td>${e.uid}</td><td>${e.nickname}</td><td><button class="delete-player-btn" data-uid="${e.uid}">刪除</button></td>`,playerManagerBody.appendChild(t)}),document.querySelectorAll(".delete-player-btn").forEach(e=>e.addEventListener("click",handleDeletePlayer))}function buildEventHistory(){if(!eventHistoryBody)return;eventHistoryBody.innerHTML="";const e=db.dailyEvents||[];if(0===e.length)return void(eventHistoryBody.innerHTML='<tr><td colspan="2" style="text-align:center;">尚無更新記錄</td></tr>');[...e].reverse().forEach((t,a)=>{const n=e.length-1-a,o=document.createElement("tr");o.innerHTML=`<td>${t.date}</td><td><button class="delete-player-btn" data-index="${n}">刪除本次更新</button></td>`,eventHistoryBody.appendChild(o)}),document.querySelectorAll("#eventHistoryTable .delete-player-btn").forEach(e=>e.addEventListener("click",handleDeleteDailyEvent))}function buildEventReviewButtons(){const e=document.getElementById("eventReviewButtons");if(!e)return;e.innerHTML="<span>查看各標的事件列表: </span>";for(const t in SinnerData){const a=document.createElement("button");a.textContent=SinnerData[t].name.split(" - ")[0],a.dataset.sinner=t,a.addEventListener("click",()=>showEventListModal(t)),e.appendChild(a)}}function showEventListModal(e){const t=SinnerData[e];eventListModalTitle.textContent=`${t.name} - 命運事件列表`;const a=[...t.events].sort((e,t)=>t.value-e.value);let n=a.map(e=>{const t=e.value>0?"positive":"negative",a=(e.value>0?"+":"")+(100*e.value).toFixed(0)+"%";return`<p class="${t}"><span class="event-desc">${e.desc}</span><span class="event-value ${t}">${a}</span></p>`}).join("");eventListModalContent.innerHTML=n,eventListModal.style.display="flex"}function handleDeletePlayer(e){const t=e.target.dataset.uid;window.confirm(`您確定要刪除UID為 ${t} 的玩家嗎？此操作無法復原。`)&&(db.players=(db.players||[]).filter(e=>e.uid!==t),saveDb())}function handleDeleteDailyEvent(e){const t=parseInt(e.target.dataset.index);window.confirm(`您確定要刪除日期為 ${db.dailyEvents[t].date} 的市場更新嗎？這將會回滾所有股價至該天之前！`)&&(db.dailyEvents=db.dailyEvents.slice(0,t),db.dailyEvents.forEach(e=>{e.events.forEach(e=>{db.stocks[e.sinnerId].price*=1+e.change})}),saveDb(),alert("市場狀態已成功回滾！"))}function handleExportData(){const e=JSON.stringify(db,null,2),t=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download="sinner_stock_db.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}function handleImportData(e){const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=function(e){try{const t=JSON.parse(e.target.result);t.players!==void 0&&t.stocks!==void 0&&window.confirm("您確定要匯入資料嗎？這將會覆蓋所有現有數據！")&&(db=t,saveDb(),alert("資料匯入成功！"))}catch(e){alert("錯誤：讀取檔案失敗，請確認是否為正確的JSON檔案。"),console.error(e)}},a.readAsText(t),e.target.value=""}function handleResetData(){window.confirm("【極度危險】您確定要重置所有活動資料嗎？所有玩家報名資料和市場事件都將被清空！此操作無法復原！")&&(resetDb(),alert("所有活動資料已成功重置！"))}function updateMarket(){const e=new Date().toLocaleDateString("sv-SE");if((db.dailyEvents||[]).some(t=>t.date===e))return void alert(`錯誤：日期 ${e} 的市場已經更新過了！`);const t={date:e,events:[]};for(const e in SinnerData){const a=document.getElementById(`${e}_select`),n=parseInt(a.value),o=SinnerData[e].events[n],i=db.stocks&&db.stocks[e]?db.stocks[e].price:INITIAL_STOCK_PRICE;db.stocks||(db.stocks={}),db.stocks[e]||(db.stocks[e]={}),db.stocks[e].price=i*(1+o.value),t.events.push({sinnerId:e,eventIndex:n,eventDesc:o.desc,change:o.value})}db.dailyEvents||(db.dailyEvents=[]),db.dailyEvents.push(t),db.gameStarted=!0,saveDb(),statusEl.textContent=`市場已於 ${new Date().toLocaleTimeString()} 更新成功！`,statusEl.style.display="block",setTimeout(()=>{statusEl.style.display="none"},5e3)}function startApp(){const e=document.getElementById("registrationForm"),t=document.getElementById("registrationClosed");if(closeEventListBtn&&closeEventListBtn.addEventListener("click",()=>eventListModal.style.display="none"),closeRulesBtn&&closeRulesBtn.addEventListener("click",()=>rulesModal.style.display="none"),cancelSubmitBtn&&cancelSubmitBtn.addEventListener("click",hideConfirmationModal),confirmSubmitBtn&&confirmSubmitBtn.addEventListener("click",submitPortfolio),"#admin5784631"===window.location.hash)return buildAdminControls(),buildPlayerManager(),buildEventHistory(),updateMarketBtn&&updateMarketBtn.addEventListener("click",updateMarket),exportDataBtn&&exportDataBtn.addEventListener("click",handleExportData),importDataInput&&importDataInput.addEventListener("change",handleImportData),resetDataBtn&&resetDataBtn.addEventListener("click",handleResetData),void navigateTo("pageAdmin");const a=localStorage.getItem("sinnerStockGameUID"),n=db.players||[];if(db.gameStarted)return e&&(e.style.display="none"),t&&(t.style.display="block"),toPage2Btn.textContent="查詢結果",toPage2Btn.disabled=!1,toPage2Btn.onclick=()=>{handlePage1Next(),navigateTo("page3")},void navigateTo("page1");if(a&&n.some(e=>e.uid===a))renderAllPage3(),navigateTo("page3"),setTimeout(()=>{const e=document.getElementById(`player-row-${a}`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("highlight-row"),setTimeout(()=>e.classList.remove("highlight-row"),3e3))},100);else{localStorage.removeItem("sinnerStockGameUID");const a=document.getElementById("registrationForm"),n=document.getElementById("registrationClosed");a&&(a.style.display="block"),n&&(n.style.display="none"),toPage2Btn.textContent="下一步 / 查詢結果",uidInput&&uidInput.addEventListener("input",validateInputs),nicknameInput&&nicknameInput.addEventListener("input",validateInputs),agreeCheckbox&&agreeCheckbox.addEventListener("change",validateInputs),rulesLink&&rulesLink.addEventListener("click",()=>rulesModal.style.display="flex"),toPage2Btn&&toPage2Btn.addEventListener("click",handlePage1Next),navigateTo("page1")}}onValue(dbRef,e=>{const t=e.val();t?db=t:(console.log("Firebase is empty, initializing database..."),resetDb()),db&&startApp()});
        });
    </script>
</body>
</html>