<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鬱金香控股: 模擬投資競賽</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #DAA520;
            --secondary-color: #00E5FF;
            --background-color: #10121a;
            --surface-color: #1a1c25;
            --text-color: #e0e0e0;
            --text-muted-color: #888;
            --positive-color: #F44336;
            --negative-color: #4CAF50;
            --danger-color: #c0392b;
            --font-heading: 'Orbitron', 'Noto Sans TC', sans-serif;
            --font-body: 'Noto Sans TC', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); background-color: var(--background-color); color: var(--text-color); line-height: 1.7; font-size: 16px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--primary-color); margin-bottom: 1rem; text-shadow: 0 0 5px rgba(218, 165, 32, 0.5); }
        button, input[type="submit"], .file-input-label { font-family: var(--font-heading); cursor: pointer; transition: all 0.3s ease; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        .page { display: none; animation: fadeIn 0.8s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #page1 { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: linear-gradient(rgba(16, 18, 26, 0.85), rgba(16, 18, 26, 1)), url('01.png') no-repeat center center/cover; }
        #page1 h1 { font-size: 3.5rem; }
        #page1 .timeline { margin: 1.5rem 0; padding: 1rem; border: 1px solid var(--secondary-color); border-radius: 8px; background-color: rgba(0, 229, 255, 0.05); }
        #page1 .timeline p { margin: 0.5rem 0; font-size: 1.1rem; }
        .form-group { margin: 1.5rem 0; width: 100%; max-width: 400px; }
        .form-group label { display: block; margin-bottom: 0.5rem; text-align: left; font-weight: 500; }
        .form-group input { width: 100%; padding: 0.8rem; background-color: var(--surface-color); border: 1px solid #444; border-radius: 5px; color: var(--text-color); font-size: 1rem; }
        .form-group .helper-text { font-size: 0.8rem; color: var(--text-muted-color); text-align: left; margin-top: 0.3rem; }
        .form-group .error-text { color: var(--danger-color); font-size: 0.9rem; text-align: left; margin-top: 0.5rem; display: none; min-height: 1.2em; }
        .form-group input.invalid { border-color: var(--danger-color); }
        .next-button { padding: 0.8rem 2.5rem; background-color: var(--primary-color); color: var(--background-color); border: none; border-radius: 5px; font-size: 1.2rem; font-weight: 700; }
        .next-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4); }
        #page2 .page-header { text-align: center; margin-bottom: 2rem; }
        .portfolio-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; align-items: stretch; }
        @media (max-width: 992px) { .portfolio-layout { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .portfolio-layout { grid-template-columns: 1fr; } }
        .sinner-investment-card, .portfolio-summary { background-color: var(--surface-color); border-radius: 8px; padding: 1.5rem; display: flex; flex-direction: column; }
        .sinner-investment-card { position: relative; border-left: 4px solid var(--secondary-color); }
        .portfolio-summary { border-left: 4px solid var(--primary-color); justify-content: center; align-items: center; text-align: center; }
        .sinner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; min-height: 42px; }
        .sinner-header h3 { margin: 0; font-size: 1.1rem; line-height: 1.2; }
        .organization-name { font-size: 0.8em; color: var(--text-muted-color); font-weight: 400; }
        .investment-controls { margin-top: auto; padding-top: 1.5rem; }
        .investment-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-family: var(--font-heading); }
        .investment-display label { font-size: 0.9rem; }
        .investment-display span { font-size: 1.2rem; color: var(--primary-color); font-weight: 700; }
        .slider-container { display: flex; align-items: center; gap: 0.5rem; }
        .adjust-btn { background-color: #444; color: var(--text-color); border: none; width: 30px; height: 30px; font-size: 1.5rem; line-height: 30px; border-radius: 50%; flex-shrink: 0; }
        .adjust-btn:hover { background-color: var(--primary-color); color: var(--background-color); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; background: #333; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 2px solid var(--background-color); }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: 2px solid var(--background-color); }
        .chart-and-info-container { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; align-items: center; }
        .event-chart-container { flex-shrink: 0; position: relative; width: 150px; height: 150px; cursor: pointer; }
        .chart-avatar { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border-radius: 50%; border: none; pointer-events: none; background-color: var(--surface-color); }
        .chart-cta { position: absolute; bottom: 0px; right: 0px; transform: translateX(calc(100% + 5px)); width: max-content; font-size: 0.7rem; color: var(--text-muted-color); font-style: italic; pointer-events: none; }
        @media (max-width: 1200px) { .chart-cta { transform: none; width: 100%; text-align: center; bottom: -20px; right: auto; left: 50%; transform: translateX(-50%); } }
        .event-description-box { width: 100%; min-height: 80px; font-size: 0.9rem; color: var(--text-muted-color); display: flex; align-items: center; }
        .event-description-box p { text-align: left; width: 100%; }
        .portfolio-summary p { font-size: 1.2rem; margin: 0.5rem 0; }
        #remainingFunds.negative { color: var(--negative-color); }
        .submit-portfolio { padding: 0.8rem 2.5rem; background-color: var(--primary-color); color: var(--background-color); border: none; border-radius: 5px; font-size: 1.2rem; font-weight: 700; margin-top: 1rem; }
        #page3 h2, #page3 h3 { text-align: center; }
        #page3 h3 { color: var(--secondary-color); margin-bottom: 1.5rem; }
        .todays-events-section { margin-bottom: 3rem; }
        .todays-events-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem; }
        @media (max-width: 1199px) { .todays-events-grid { display: flex; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 1rem; } }
        .today-event-card { background-color: var(--surface-color); border-radius: 8px; padding: 1.5rem; text-align: center; border-bottom: 4px solid; flex: 1 0 220px; }
        .today-event-card.positive { border-color: var(--positive-color); }
        .today-event-card.negative { border-color: var(--negative-color); }
        .today-event-card .sinner-name { font-weight: 700; color: var(--text-color); font-size: 1.1rem; margin-bottom: 1rem; }
        .today-event-card .event-impact { font-family: var(--font-heading); font-size: 3rem; font-weight: 700; margin-bottom: 1rem; }
        .today-event-card .event-impact.positive { color: var(--positive-color); }
        .today-event-card .event-impact.negative { color: var(--negative-color); }
        .today-event-card .event-desc { font-size: 0.9rem; color: var(--text-muted-color); min-height: 50px; }
        .market-view-container { background-color: var(--surface-color); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; }
        .market-view-grid { display: grid; grid-template-columns: 120px repeat(5, 1fr); gap: 1px; background-color: #444; border: 1px solid #444; min-width: 900px; }
        .market-view-container-desktop { overflow-x: auto; }
        .market-view-cell { background-color: var(--background-color); padding: 0.5rem; font-size: 0.8rem; }
        .market-view-header { background-color: #2a2a2a; font-family: var(--font-heading); font-weight: 700; text-align: center; color: var(--primary-color); position: sticky; top: 0; z-index: 3; white-space: nowrap; }
        .date-header { text-align: left; position: sticky; left: 0; z-index: 2; }
        .event-cell { min-height: 60px; }
        .event-cell .event-desc { color: var(--text-color); font-size: 0.85rem; }
        .event-cell .event-impact { font-weight: 700; text-align: right; display: block; margin-top: 0.5rem; }
        .event-cell .event-impact.positive { color: var(--positive-color); }
        .event-cell .event-impact.negative { color: var(--negative-color); }
        .market-view-mobile-card { background-color: var(--background-color); border: 1px solid #444; border-radius: 5px; margin-bottom: 1rem; padding: 1rem; }
        .market-view-mobile-card h4 { color: var(--primary-color); margin: 0 0 1rem 0; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        .mobile-event-item { display: grid; grid-template-columns: 1fr auto; gap: 0.5rem 1rem; padding: 0.5rem 0; border-bottom: 1px solid #2a2a2a; }
        .mobile-event-item:last-child { border-bottom: none; }
        .mobile-event-item .sinner-name { grid-column: 1 / 2; font-weight: bold; }
        .mobile-event-item .event-impact { grid-column: 2 / 3; grid-row: 1 / 3; align-self: center; font-size: 1.2rem; font-weight: 700; }
        .mobile-event-item .event-impact.positive { color: var(--positive-color); }
        .mobile-event-item .event-impact.negative { color: var(--negative-color); }
        .mobile-event-item .event-desc { grid-column: 1 / 2; font-size: 0.85rem; color: var(--text-muted-color); }
        #marketViewMobile { display: none; }
        @media (max-width: 768px) { .market-view-container-desktop { display: none; } #marketViewMobile { display: block; } }
        .leaderboard-table-container { overflow-x: auto; }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
        .leaderboard-table th, .leaderboard-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid #333; vertical-align: middle; }
        .leaderboard-table thead { background-color: #2a2a2a; }
        .leaderboard-table thead th { color: var(--primary-color); }
        .leaderboard-table tbody tr:nth-child(-n+10) { background-color: rgba(244, 67, 54, 0.05); } /* Red for top */
        .leaderboard-table tbody tr:nth-last-child(-n+10) { background-color: rgba(76, 175, 80, 0.05); } /* Green for bottom */
        .leaderboard-table .rank { font-family: var(--font-heading); font-weight: 700; }
        .leaderboard-table .nickname { font-weight: 500; }
        .leaderboard-table .portfolio-details { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .portfolio-item { font-size: 0.8rem; color: var(--text-muted-color); white-space: nowrap; }
        .portfolio-item strong { color: var(--text-color); font-weight: 700; }
        .leaderboard-table .net-worth { font-weight: 700; font-family: var(--font-heading); }
        .daily-change { font-weight: 700; font-family: var(--font-heading); }
        .daily-change.positive { color: var(--positive-color); }
        .daily-change.negative { color: var(--negative-color); }
        @keyframes highlight-row-animation { from { background-color: rgba(218, 165, 32, 0.5); } to { background-color: transparent; } }
        .highlight-row { animation: highlight-row-animation 3s ease-out; }
        #pageAdmin { background-color: #2c3e50; padding: 2rem; border-radius: 8px; }
        #pageAdmin h1, #pageAdmin h2 { color: #f1c40f; }
        .admin-section { background-color: #34495e; padding: 1.5rem; margin-bottom: 2rem; border-radius: 8px; }
        #pageAdmin label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        #pageAdmin select, #pageAdmin input { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 4px; border: none; }
        #updateMarketBtn, .delete-player-btn, .admin-button { background-color: #e67e22; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; margin-right: 1rem; }
        #updateMarketBtn:hover, .delete-player-btn:hover, .admin-button:hover { background-color: #d35400; }
        .delete-player-btn, #resetDataBtn { background-color: var(--danger-color); }
        .delete-player-btn:hover, #resetDataBtn:hover { background-color: #e74c3c; }
        .file-input-label { display: inline-block; padding: 0.8rem 1.5rem; background-color: #3498db; color: white; border-radius: 4px; }
        .file-input-label:hover { background-color: #2980b9; }
        #importDataInput { display: none; }
        #status { margin-top: 1rem; padding: 1rem; background-color: #27ae60; color: white; border-radius: 4px; display: none; text-align: center;}
        #playerManagerTable, #eventHistoryTable { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #playerManagerTable th, #playerManagerTable td, #eventHistoryTable th, #eventHistoryTable td { padding: 0.5rem; border: 1px solid #46627f; text-align: left; }
        #playerManagerTable th, #eventHistoryTable th { background-color: #2c3e50; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 8px; border: 1px solid var(--primary-color); width: 90%; max-width: 500px; text-align: center; }
        #portfolioReview { text-align: left; margin: 1.5rem 0; max-height: 250px; overflow-y: auto; border: 1px solid #444; padding: 1rem; border-radius: 5px; }
        #portfolioReview p { display: flex; justify-content: space-between; }
        #portfolioReview .sinner-name { color: var(--text-muted-color); }
        #portfolioReview .amount { font-family: var(--font-heading); color: var(--primary-color); }
        .modal-warning { color: var(--negative-color); font-weight: bold; margin-bottom: 1.5rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        .modal-buttons button { padding: 0.6rem 1.5rem; border-radius: 5px; font-size: 1rem; }
        #confirmSubmitBtn { background-color: var(--primary-color); color: var(--background-color); border: none; }
        #cancelSubmitBtn { background-color: transparent; color: var(--text-muted-color); border: 1px solid var(--text-muted-color); }
        #rulesModal .modal-content, #eventListModal .modal-content, #infoModal .modal-content { text-align: left; max-width: 700px; }
        #infoModal .modal-content { max-width: 400px; text-align: center; }
        #rulesModal ul, #eventListModal ul { padding-left: 1.5rem; margin: 1rem 0; }
        #rulesModal li, #eventListModal li { margin-bottom: 0.5rem; }
        #rulesModal .rule-highlight { color: var(--negative-color); font-weight: bold; }
        #closeRulesBtn, #closeEventListBtn, #closeInfoBtn { display: block; margin: 1.5rem auto 0; }
        .rules-link { text-decoration: underline; color: var(--secondary-color); cursor: pointer; font-size: 0.9rem; }
        .agree-section { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        #eventListModalContent { max-height: 70vh; overflow-y: auto; }
        #eventListModalContent p { padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; font-size: 0.9rem; }
        #eventListModalContent p.positive { background-color: rgba(244, 67, 54, 0.1); }
        #eventListModalContent p.negative { background-color: rgba(76, 175, 80, 0.1); }
        #eventListModalContent .event-value { font-weight: 700; }
        #eventListModalContent .event-value.positive { color: var(--positive-color); }
        #eventListModalContent .event-value.negative { color: var(--negative-color); }
        #eventReviewButtons { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
        #eventReviewButtons button { background-color: var(--surface-color); border: 1px solid var(--secondary-color); color: var(--secondary-color); padding: 0.5rem 1rem; }
        #eventReviewButtons button:hover { background-color: var(--secondary-color); color: var(--background-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="page1" class="page">
            </div>
        <div id="page2" class="page">
            </div>
        <div id="page3" class="page">
            </div>
        <div id="pageAdmin" class="page">
            </div>
    </div>
    <div id="confirmationModal" class="modal-overlay"> </div>
    <div id="rulesModal" class="modal-overlay"> </div>
    <div id="eventListModal" class="modal-overlay"> </div>
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="infoModalTitle">提示</h3>
            <p id="infoModalMessage" style="margin-top: 1rem;"></p>
            <button id="closeInfoBtn" class="next-button">確定</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // ... Firebase Config ...

        document.addEventListener('DOMContentLoaded', function() {
            
            // ... SinnerData, constants, DOM elements ...
            
            let db = {};
            let currentInfoModalCallback = null;
            let isFirstLoad = true;

            function showInfoModal(message, title = '提示', callback = null) { /* ... */ }
            function toggleRegistration() { /* ... */ }
            function updateAdminUI() { /* ... */ }
            
            // 【修正】將儲存操作精準化
            function saveNewPlayer(playerData) {
                const currentPlayers = db.players || [];
                const newPlayers = [...currentPlayers, playerData];
                const path = ref(database, 'sinnerStockGame/players');
                return set(path, newPlayers);
            }

            function saveAllPlayers(players) {
                const path = ref(database, 'sinnerStockGame/players');
                return set(path, players);
            }
            
            function saveMarketUpdate(stocks, dailyEvents) {
                const updates = {};
                updates['/stocks'] = stocks;
                updates['/dailyEvents'] = dailyEvents;
                return update(ref(database, 'sinnerStockGame'), updates);
            }
            
            function resetDb() {
                const initialDb = { 
                    players: [], 
                    stocks: {}, 
                    dailyEvents: [], 
                    registrationClosed: false 
                };
                for (const sinnerId in SinnerData) {
                    initialDb.stocks[sinnerId] = { price: INITIAL_STOCK_PRICE };
                }
                set(dbRef, initialDb);
            }

            function navigateTo(pageId) { /* ... */ }
            function validateInputs() { /* ... */ }

            function handlePage1Next() {
                const uid = uidInput.value.trim();
                if (!uid) { return showInfoModal("請先輸入您的UID。"); }
                const isRegistered = (db.players || []).some(p => p.uid === uid);

                if (db.registrationClosed) {
                    if (isRegistered) {
                        showInfoModal('此UID已報名，將為您跳轉至排行榜。', '查詢結果', () => {
                            localStorage.setItem('sinnerStockGameUID', uid);
                            navigateTo('page3');
                            setTimeout(() => {
                                const playerRow = document.getElementById(`player-row-${uid}`);
                                if (playerRow) {
                                    playerRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    playerRow.classList.add('highlight-row');
                                    setTimeout(() => playerRow.classList.remove('highlight-row'), 3000);
                                }
                            }, 100);
                        });
                    } else {
                        showInfoModal('抱歉，報名時間已過。');
                    }
                } else { 
                    if (isRegistered) {
                        showInfoModal('此UID已報名，將為您跳轉至排行榜。', '查詢結果', () => {
                            localStorage.setItem('sinnerStockGameUID', uid);
                            navigateTo('page3');
                        });
                    } else {
                        buildPortfolioPage();
                        navigateTo('page2');
                        const page2Element = document.getElementById('page2');
                        if (page2Element) {
                            page2Element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                }
            }
            
            // ... buildPortfolioPage, renderAllCharts, etc. ...

            // 【修正】修改 submitPortfolio 以使用精準的儲存函式
            function submitPortfolio() {
                const uid = uidInput.value.trim();
                const nickname = nicknameInput.value.trim() || `局長${uid.slice(-4)}`;
                const players = db.players || [];
                if (players.some(p => p.uid === uid)) {
                    return void showInfoModal('此UID已報名，無法重複提交！');
                }
                const portfolio = {};
                document.querySelectorAll('.investment-input').forEach(input => {
                    const amount = Number(input.value);
                    if (amount > 0) portfolio[input.dataset.sinner] = amount;
                });
                const newPlayer = { uid, nickname, portfolio };
                
                // 使用新的、精準的儲存函式
                saveNewPlayer(newPlayer).then(() => {
                    localStorage.setItem('sinnerStockGameUID', uid);
                    hideConfirmationModal();
                    showInfoModal('投資組合提交成功！祝您投資順利！', '提交成功', () => {
                        navigateTo('page3');
                    });
                }).catch(err => {
                    console.error("新增玩家失敗: ", err);
                    showInfoModal('提交失敗，請檢查 Firebase 權限或網路連線。');
                });
            }

            // ... 其他渲染函式 ...

            // 【修正】修改後台操作函式以使用精準的儲存
            function handleDeletePlayer(event) {
                const uidToDelete = event.target.dataset.uid;
                if (window.confirm(`您確定要刪除UID為 ${uidToDelete} 的玩家嗎？此操作無法復原。`)) {
                    const newPlayers = (db.players || []).filter(p => p.uid !== uidToDelete);
                    saveAllPlayers(newPlayers); // 使用精準儲存
                }
            }
            
            function updateMarket() {
                // ...
                // 原本的 db.gameStarted = true 移除，由後台按鈕控制
                saveMarketUpdate(db.stocks, db.dailyEvents).then(() => { // 使用精準儲存
                    showInfoModal(`市場已於 ${new Date().toLocaleTimeString()} 更新成功！`, '更新成功');
                }).catch(err => {
                    console.error("更新市場失敗:", err);
                    showInfoModal("更新市場失敗，請檢查 Firebase 權限。");
                });
            }


            function startApp() {
                // ...
            }

            function updateDynamicContent() {
                // ...
            }
            
            // 程式主進入點
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db = data;
                } else {
                    console.log("Firebase is empty, initializing database...");
                    resetDb();
                    return; 
                }
                
                if (isFirstLoad) {
                    isFirstLoad = false;
                    startApp();
                } else {
                    updateDynamicContent();
                }
            });
        });
    </script>
</body>
</html>